# SQLite REPLACE #########################

[Файл с запросами][querys]   
[Оригинальная статья][origin]

[querys]: ./querys.sql
[origin]: https://www.sqlitetutorial.net/sqlite-replace-statement/

## Обзор ##############################

В это руководстве вы изучите как использовать выражение SQLite `REPLACE` для вставки и замены строк в таблице.

## Знакомство с выражением SQLite `REPLACE`

Идея выражения `REPLACE` заключается в том, что когда нарушены ограничения `UNIQUE` и `PRIMARY KEY`, оно выполняет следующее:

- Первое, удаляет существующую строку, которая нарушает ограничения.

- Второе, вставляет новую строку.

Во время второго шага, если какое-либо ограничение нарушено, например, `NOT NULL`, выражение `REPLACE` отменит действие и откатит транзакцию.

Ниже приведен синтаксис выражения `REPLACE`:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
INSERT OR REPLACE INTO table (column_list)
VALUES (value_list);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Или сокращенная форма: 

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
REPLACE INTO table (column_list)
VALUES (value_list);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Давайте посмотрим несколько примеров выражения SQLite `REPLACE` чтобы понять, как оно работает.

## Примеры выражения SQLite `REPLACE`

Сначала, создадим новую таблицу под названием `positions` со следующей структурой:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
CREATE TABLE IF NOT EXISTS positions (
  id INTEGER PRIMARY KEY,
  title TEXT NOT NULL,
  min_salary NUMERIC
);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Потом, вставим несколько строк в таблицу `positions`:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
INSERT INTO positions (title, min_salary)
VALUES 
  ('DBA', 120000),
  ('Developer', 100000),
  ('Architect', 150000);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Затем, проверим вставку следующим выражением `SELECT`:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT * FROM positions;
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Следующее выражение создает уникальный индекс на столбец `title` таблицы `positions`, чтобы удостовериться, что он не имеет каких-либо дубликатов должностей:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
CREATE UNIQUE INDEX idx_positions_title
ON positions (title);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Предположим, вы хотите добавить должность в таблицу `positions` если ее еще нет, и в случае, если должность есть, обновить ее.

Следующее выражение `REPLACE` вставит новую строку в таблицу `positions`, так как названия должности `Full Stack Developer` нету.

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
REPLACE INTO positions (title, min_salary)
VALUES ('Full Stack Developer', 140000);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Посмотрите следующее выражение:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
REPLACE INTO positions (title, min_salary)
VALUES ('DBA', 170000);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Первое, SQLite проверяет ограничение `UNIQUE`.

Второе, из-за того, что выражение нарушает ограничение `UNIQUE`, пытаясь добавить название `DBA`, которое уже есть, SQLite удаляет существующую строку.

Третье, SQLite вставляет новую строку с данными переданными выражением `REPLACE`.

> Обратите внимание, что выражение `REPLACE` значит `INSERT` или `REPLACE`, а не `INSERT` или `UPDATE`.

Посмотрите слудующее выражение:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
REPLACE INTO positions (id, min_salary)
VALUES (2, 110000);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Это выражение пытается обновить `min_salary` на позиции 2.

Первое, позиция с id 2 уже существует, выражение `REPLACE` удаляет его.

Затем, SQLite пытается вставить новую строку с двумя столбцами: (`id`, `min_salary`). Однако это нарушает ограничение `NOT NULL` колонки `title`. Следовательно SQLite откатит транзакцию.

Если столбец `title` не имеет онграничения `NOT NULL`, выражение `REPLACE` вставит новую строку, чей столбец `title` будет `NULL`.

В этом руководстве мы показали вам, как использовать выражение SQLite `REPLACE` для вставки или замены строки в таблице.

Предидущее руководство < [SQLite DELETE][prev]  
Следующее руководство > [SQLite TRANSACTION][next]

[prev]: ../27_Delete/translate.md
[next]: ../29_Transaction/translate.md