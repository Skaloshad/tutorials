# SQLite FULL-TEXT SEARCH #########################

[Файл с запросами][querys]   
[Оригинальная статья][origin]

[querys]: ./querys.sql
[origin]: https://www.sqlitetutorial.net/sqlite-full-text-search/

## Обзор ##############################

В этом руководстве вы изучите, как использовать полный поиск по тексту SQLite используя модуль виртуальной таблицы FTS5.

## Знакомство с полным поиском по тексту SQLite

Виртуальная таблица - это пользовательское расширение SQLite. Виртуальная таблица похожа на обычную таблицу. Разница между вируальной таблицей и нормальной таблицей в том, откуда поступают данные, например, когда вы обрабатываете обычную таблицу, SQLite читает файл базы данный для получения данных. В то время как, когда вы работаете с виртуальной таблицей, SQLite вызывает пользовательский код для получения данных. Пользовательский код может содержать определенную логику для выполнения определенных задач, таких как получение данных из нескольких источников.

Для использоватия полного поиска по тексту в SQLite используется модуль витруальных таблиц FTS5.

Следующее выражение `CTEATE VIRTUAL TABLE` создает таблицу FTS5 с двумя колонками:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
CREATE VIRTUAL TABLE table_name
USING FTS5 (column1, column2...);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

> Обратите внимание, что вы не можете добавлять типы, ограничения или объявление `PRIMARY KEY` в выражении `CREATE VIRTUAL TABLE` для моздания таблицы FTS5. Если вы это сделаете SQLite выдаст ошибку.

Как и при создании обычной таблицы без определения колонки первичного ключа, SQLite добавит неявную колонку `rowid` в таблицу FTS5.

Следующий пример создаст таблицу FTS5 под названием `posts` с двумя столбцами `title` и `body`.

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
CREATE VIRTUAL TABLE posts
USING FTS5 (title, body);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Также как и в обычных таблицах, вы можете вставлять данные в `posts` как показано ниже:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
INSERT INTO posts (title, body)
VALUES ('Learn SQLite FTS5', 'This tutorial teaches you how to perform full-text search in SQLite using FTS5'),
('Advanced SQLite Full-text Search', 'Show you some advanced techniques in SQLite full-text searching'),
('SQLite Tutorial', 'Help you learn SQLite quickly and effectively');
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

И запросим данные по нему:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT * FROM posts;
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

## Запрос данных используя полный поиск по тексту

Вы можете выполнить запрос с полным поиском по тексту из таблицы FTS5 одним из трёх путей:

- Первый - Использовать оператор `MATCH` в предложении `WHERE` выражения `SELECT`. Например, для получения всех строк, которые имеют термин `fts5`, используется следующий запрос:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT *
FROM posts
WHERE posts MATCH 'fts5';
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

- Второй - Использовать оператор равенства (`=`) в предложении `WHERE` выражения `SELECT`. Следующее выражение вернет тот же результать, что и выражение выше:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT *
FROM posts
WHERE posts = 'fts5';
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

- Третий - Использовать синтаксис функции с табличным значением. В этом случае используйте поисковое слово как первый аргумент функции:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT *
FROM posts('fts5');
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

По умолчанию FTS5 регистро-независимая. Он трактует термины `fts5`, `FTS5` и `Fts5` одинакого.

Чтобы отсортировать результаты поиска по релевантности, используется предложение `ORDER BY`, как показано ниже:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT *
FROM posts
WHERE posts MATCH 'text'
ORDER BY rank;
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

## Использование синтаксиса запроса с полным поиском по тексту

Полнотекстовый поиск состоит из фраз, каждая из которых является упорядоченным списком из одно или более токенов. Вы можете использовать оператор `+` для соединения двух фраз, как показано ниже:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
"learn SQLite"
"learn + SQLite"
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

FTS5 определяет, соответствует ли документ фразе если документ содержит хотябы одну подпоследовательность токенов, которые соответствуют последовательности токенов во фразе.

Следующий запрос возвращает все документы, которые содержат выражение `Learn SQLite`: 

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT *
FROM posts
WHERE posts MATCH 'learn SQLite';
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

### Посик по префексу

Вы можете использовать звездочку (`*`) в качестве префиксного маркера. Когда фраза содержит звездочку, это приведет к тому, что каждый документ, содержащий токен начинающийся с этой фразы попадет в выборку. Например, `search*` найдет следующие слова: `search`, `searching`, `searches`, и т.д. Посмотрите пример:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT *
FROM posts
WHERE posts = 'search*';
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

### Булевы операторы

Вы можете использовать булевы операторы, такие как: `NOT`, `OR` или `AND` - для комбинирования запросов.

- q1 `AND` q2: совпадение, если оба запроса имеют совпадения.
- q1 `OR` q2: совпадение, если любой из запросов имеет совпадения.
- q1 `NOT` q2: совпвдение, если первый запрос имеет совпадения, а второй нет.

Например, для получения документов, которые совподают с фразой `learn` но не совпадают с фразой `FTS5` используется оператор `NOT`:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT *
FROM posts
WHERE posts MATCH 'learn NOT text';
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Для поиска документов, которые имеют либо фразу `learn` либо `text` используйте оператор `OR`, как показано ниже:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT *
FROM posts
WHERE posts MATCH 'learn OR text';
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Для поиска документов, которые имеют оба вхождения, используйте оператор `AND`, как показано ниже:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT *
FROM posts
WHERE posts MATCH 'sqlite AND searching';
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Для изменения порядка выполнения операторов, используйте круглые скобки для гурппировки выражений. Например:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT *
FROM posts
WHERE posts MATCH 'search AND sqlite OR help';
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Это выражение возвращает документы, которые совподают с `search` и `sqlite` или `help`. Для поиска документов, которые совподают с `search` и либос с `sqlite` либо с `help`, используйте круглые скобки, как показано ниже:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT *
FROM posts
WHERE posts MATCH 'search AND (sqlite OR help)';
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

## Встроенные вспомогательные функции

SQLite предоставляет встроенные вспомогательные функции, которые могут быть сипользованы внутри полнотекстовых запросов из таблиц FTS5.

- `bm25()` возвращает точность текущего совпадения, где меншее значение означает лучшее совпадение.
- `highlight()` вспомогательная функция, которая возвращает копию текста со словами поиска, окруженными специальными символами, например, <b>search term</b>.
- `snippet()` выбирает короткий фрагмент текста, чтобы максимально увеличить количество содержащихся в нем поисковых запросов.

Например, следующий запрос использует функцию `highlight()` для декорации поисковых слов используя тег <b>:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT 
  highlight(posts, 0, '<b>', '</b>') title,
  highlight(posts, 1, '<b>', '</b>') body
FROM posts
WHERE posts MATCH 'SQLite'
ORDER BY rank;
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

В этом руководстве вы изучили как использовать полнотекстовой поиск в модуле виртуальных таблиц FTS5.

---------------------------------------

Предидущее руководство < [SQLite TRANSACTION][prev]  
Следующее руководство > [SQLite DATA TYPES][next]

[prev]: ../29_Transaction/translate.md
[next]: ../31_DataTypes/translate.md