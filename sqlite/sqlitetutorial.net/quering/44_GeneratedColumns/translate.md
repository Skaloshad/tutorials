# SQLite GENERATED COLUMNS #########################

[Файл с запросами][querys]   
[Оригинальная статья][origin]

[querys]: ./querys.sql
[origin]: https://www.sqlitetutorial.net/sqlite-generated-columns/

## Обзор ##############################

В этом руководстве вы узнаете о генерируемых столбцах SQLite

## Знакомство с генерируемыми столбцами SQLite

SQLite представила генерируемые столбцы в версии 3.31.0.

Заявлено, что генерируемые столбцы, это столбцы таблицы, чьи значения взяты из выражения, которое использует другие столбцы этой таблицы.

Герерируемые столбцы также известны как вычисляемые столбцы.

Для объявления генерируемого столбца используется синтаксис ограничения столбца `GENERATED ALWAYS` как показано ниже:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
column_name data_type
  [GENERATED ALWAYS] AS expression
  [VIRTUAL | STORED]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Здесь показано, что вы должны определить `expression` которое вычисляет значениея колонки `column_name` после ключевого слова `GENERATED ALWAYS`. `expression` обычно вычисляет значение используя ту же строку в той же таблице.

Ключевое слово `GENERATED ALWAYS` является не обязательным. Следовательно, вы можете написать это короче, как показано ниже:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
column_name data_type AS expression [VIRTUAL | STORED]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Генерируемые столбцы могут быть либо `VIRTUAL` либо `STORED`.

Если генерируемый столбец `VIRTUAL`, SQLite не хранит его значения физически. Вместо этого, когда вы читаете из генерируемого столбца SQLite вычисляет эти значения, основываясь на указанном выражении в объявлении столбца.

В случае, если генерируемый столбец `STORED`, SQLite хранит значения столбца физически. Другими словами, генерируемые столбцы `STORED` занимают место в файле базы данных. SQLite обновляет эти значения когда вы записываете в БД.

По умолчанию SQLite использует `VIRTUAL`, когда вы явно не указали `VIRTUAL` или `STORED` во время объявления столбца.

На практике, используется `STORED` когда вы хотите оптимизировать чтение и `VIRTUAL` когда вы хотите оптимизировать запись.

## Примеры генерируемых столбцов SQLite

1. Создадим таблицу под названием `products` используя выражение `CREATE TABLE`:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
CREATE TABLE products (
  name TEXT NOT NULL,
  price REAL NOT NULL,
  discount REAL NOT NULL,
  tax REAL NOT NULL,
  net_price REAL GENERATED ALWAYS
    AS (price * (1 - discount) * (1 + tax))
);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

В таблице `products` столбец `net_price` является генерируемым столбцом, чьи значения вычисляются из столбцов `price`, `discount` и `tax`.

Поскольку мы не объявили `VIRTUAL` или `STORED` для колонки `net_price`, она является `VIRTUAL` по умолчанию.

2. Вставим новую строку в таблицу `products`.

> Обратите внимание, что мы не передаем значение `net_price`:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
INSERT INTO products (name, price, discount, tax)
VALUES ('ABC Widget', 100, 0.05, 0.07);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

3. Выберем данные из таблицы `products`:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT * FROM products;
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Как вы можете видеть из вывода, значение колонки `net_price` вычислено, основываясь на значениях `price`, `discount` и `tax`.

## Особенности генерируемых столбцов SQLite

Генерируемые столбцы имеют следующие особенности:

- Генерируемые столбцы могут имет тип данных. SQLite преобразует значение из выражения в тип данных используя некоторые правила, как в обычных колонках.

- Генерируемые столбцы могут иметь ограничения `NOT NULL`, `CHECK`, `UNIQUE`, `FOREIGN KEY`.

- Могут быть частью одного или нескольких индексов.

- Могут ссылатся на другие столбцы, включаяя другие сгенерированные столбцы внутри той же таблицы до тех пор, пока не ссылается сам на себя.

SQLite устанавливает следующие ограничения для вычисляемых столбцов:

- Не могут имет значение по умолчанию.

- Не могут быть частью первичного ключа.

- Если таблица имеет вычисляемый столбец, она должна иметь хотябы один вычисляемый столбец.

- Нет возможности использовать `ALTER TABLE ADD COLUMN` для `STORED` колонки. Однако вы можете это использовать для `VIRTUAL` колонки.

- Не может ссылатся сама на себя, ни на прямую ни как-то ещё.

- Выражение не может использовать подзапросы, функции аггригации, функции Windows или табличные функции. Можно использовать только литералы, колонки внутри строки, и скалярно детерминированные функции.

- Выражение может ссылатся на `INTEGER PRIMARY KEY` но не может ссылаться на `ROWID` напрямую.

## Итог

- Генерируемые столбцы - это столбцы, значение которых вычисляется из других столбцов тойже таблицы.

- Используйте ограничение `GENERATED ALWAYS` для объявления вычисляемого столбца.

- Используйте опции `VIRTUAL` или `STORED`. `STORED` занимает место в базе данных, тогда как `VIRTUAL` нет. По умолчанию используется `VIRTUAL`.

---------------------------------------

Предидущее руководство < [SQLite DROP TALBE][prev]  
Следующее руководство > [SQLite VACUUM][next]

[prev]: ../43_DropTable/translate.md
[next]: ../45_Vacuum/translate.md