# SQLite SELF JOIN ######################

[Файл с запросами][querys]   
[Оригинальная статья][origin]

[querys]: ./querys.sql
[origin]: https://www.sqlitetutorial.net/sqlite-self-join/

## Обзор ##############################

В этом руководстве вы узнаете о специальном типе объединений, называемых self-join, которые позволяют объединять таблицу саму на себя.

> Обратите внимание, что вы должны быть знакомы с предложениями `INNER JOIN` и `LEFT JOIN` перед тем, как идти дальше.

## Знакомство с SQLite self-join

Self-join - это специальный вид объединений, который позволяет объединять таблицу саму с собой, используя любое из предложений `LEFT JOIN` или `INNER JOIN`. Self-join используется для получения результата, который содержит объединения строк с другими снутренними строками той-же таблицы.

Из-за того, что мы не можем ссылатся на одну таблицу несколько раз в запросе, вы должны использовать алиас таблицы, чтобы присвоить таблице другое название, затым используется self-join.

Self-join сравнивает значения того-же или другого столбца из этой же таблицы. Только одна таблица учавствует в self-join.

Обычно, self-join используется для запроса отношений родитель\ребенок, хранимых в таблице, или для подведения итогов.

## Примеры SQLiter self-join

Мы будем использовать таблица `employees` тестовой БД для демонстрации.

![employees][]

Таблица `employees` хранит не только данные сотрудников, но и организационные данные. Столбец `reportsTo` указывает на отношения отчетности между сотрудниками.

Если сотрудник отчитывается перед менеджером, значение колонки `reportsTo` строки сотрудника, будет равно значению колонки `employeeId` строки менеджера. В случае если сотрудник ни перед кем не отчитывается, столбец `reportsTo` будет `NULL`.

Для получения информации о том, кто кому подчиняется, используется следующее выражение:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT 
  m.firstname || ' ' || m.lastname AS 'Manager',
  e.firstname || ' ' || e.lastname AS 'Direct report'
FROM
  employees e
INNER JOIN employees m ON m.employeeId = e.reportsTo
ORDER BY manager;
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

![01_resultset][]

Выражение использует `INNER JOIN` для объединения `employees` с самой сабой. Таблица `employees` имеет две роли: сотрудник и менеджер.

Из-за того, что мы использовали предложение `INNER JOIN` для объединения с самой собой, результат не миеет строк, чей столбец `manager` содержит значение `NULL`.

> Обратите внимание на [оператор конкатенации][concat] `||` соединяет несколько строк в одну строку. В этом примере мы используем оператор конкатенации для получения полного имени сотрудника путем объединения имени, пробела и фамилии.

В случае если вы хотите запросить СЕО, которые никому не подчиняются, вы должны заменить предложение `INNER JOIN` на `LEFT JOIN`.

![02_resultset][]

`Andrew Adams` СЕО, потому что он никому не подчиняется.

Вы можете использовать self-join для поиска сотрудников, которые расположены в одном городе используя следующий запрос:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SELECT DISTINCT
  e1.city,
  e1.firstname || ' ' || e1.lastname AS fullname
FROM
  employees e1
INNER JOIN employees e2 ON e2.city = e1.city
  AND (e1.firstname <> e2.firstname AND e1.lastname <> e2.lastname)
ORDER BY
  e1.city;
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

![03_resultset][]

Условие объединения содерит два выражения:

- `e1.city = e2.city` для того, чтобы быть уверенным в том, что оба сотрудника находятся в одном городе.

- `e1.firstname <> e2.firstname AND e1.lastname <> e2.lastname`, чтобы убедиться, что `e1` и `e2` не один и тот же сотрудник, исходя из предположения, что нет сотрудников с одинаковыми именами.

В этом руководстве мы показали вам как использовать технику SQLite self-join для объединения таблицы саму с собой.

Предидущее руководство < [SQLite FULL OUTER JOIN][prev]  
Следующее руководство > [SQLite GROUP BY][next]

[prev]: ../15_FullOuterJoin/translate.md
[next]: ../17_GroupBy/translate.md

[concat]: https://www.sqlitetutorial.net/sqlite-string-functions/sqlite-concat/

[employees]: ./employees.png
[01_resultset]: ./01_resultset.png
[02_resultset]: ./02_resultset.png
[03_resultset]: ./03_resultset.png