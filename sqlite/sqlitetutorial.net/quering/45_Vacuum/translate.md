# SQLite VACUUM #########################

[Файл с запросами][querys]   
[Оригинальная статья][origin]

[querys]: ./querys.sql
[origin]: https://www.sqlitetutorial.net/sqlite-vacuum/

## Обзор ##############################

В этом руководстве мы объясним вам, почему вам нужно использовать команду SQLite `VACUUM` и покажем, как использовать ее для оптимизации работы файла базы данных.

## Зачем нам нужна команда SQLite `VACUUM`

1. Когда вы удаляете объекты базы данных, такие как таблицы, представления, индексы и триггеры, или удаляете данные из таблицы, размер файла базы данных не меняется. Это происходит потому, что SQLite только помечает удаленные объекты, как свободные, и оставляет это для будующих пользователей. Как результат, размер файла базы данных постоянно растет.

2. Когда вы вставляете или удаляете данные из таблиц, иднексы и таблицы становятся фрагментированными, особенно это актуально для таблиц с большим количеством вставок и удалений.

3. Операторы вставки, обновления и удаления создают неиспользуемые блоки данных внутри индивидуальной страницы базы. Это уменьшает количество строк, которое вы можете хранить на одной странице. Следовательно, это увеличивает количество страниц в таблице. Из-за этого увеличивается занимаемое место таблицы, увеличивается время чтения\записи и уменьшается производительность кеша.

![VACUUM]

SQLite предоставляет команду `VACUUM` для решения всех вышеперечисленных проблем.

Сначала SQLite копирует данные внутри файла базы во временную базу. Эта операция дефрагментирует объекты БД, игнорирует свободное место и перепаковывает индивидуальные страницы. Затем SQLite копирует контент временной БД обратно в оригинальный файл БД. Оригинальный файл БД перезаписан.

В следствии того, что команда `VACUUM` пересобирает БД, вы можете использовать ее для изменения конфигурационных параметров, таких как размер страницы, формат страницы и кодировка по умолчанию. Чтобы зделать это используется `PRAGMA` и затем `VACUUM`.

## Команда SQLite `VACUUM`

Команда `VACUUM` не меняет контент базы данных за исключением значений `ROWID`. Если вы используете `INTEGER PRIMARY KEY`, `VACUUM` не изменит значение этой колонки. Однака, если вы используете `ROWID` без алиаса, то его значения будут пересчитаны. Помимо изменений `ROWID` команда `VACUUM` создает индексы снуля.

Является хорошей практикой время от времени выполнять команду `VACUUM`, особенно если вы удаляли большую таблицу или индексы.

> Обратите внимание, что команда `VACUUM` требует место для храниния оригинального файла БД, а также его копии. Также, команда `VACUUM` требует полного доступа к файлу БД. Другими словами, она не запуститься если БД выполняет какое-либо выражение SQLite или открытую транзакцию

В настоящее время, начиная с версии 3.9.2, вы можете запустить команду `VACUUM` в основной базе данных, а не в прикрепленном файле базы данных.

Несмотря на то, что SQLite включает режим автоматического вакуумирования, который запускает процесс вакуумирования автоматически, с некоторыми ограничениями. Рекомендуется запускать команду `VACUUM` вручную.

## Как запустить команду SQLite `VACUUM`

Следующее выражение запускает команду `VACUUM`:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
VACUUM;
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

> Убедитесь, что во время выполнения команды нет открытой транзакции.

Следующая инструкция включает режим полного автоматического вакуумирования:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PRAGMA auto_vacuum = FULL;
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Чтобы включить инкрементный вакуум, вы используете следующую инструкцию:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PRAGMA auto_vacuum = INCREMENTAL;
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Следующая инструкция отключает режим автоматического вакуумирования:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PRAGMA auto_vacuum = NONE;
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

## `VACUUM` с предложением `INTO`

Вот синтаксис предложения `VACUUM` with `INTO`:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
VACUUM schema-name INTO filename;
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Оператор `VACUUM` с предложением `INTO` сохраняет исходный файл базы данных неизменным и создает новую базу данных с указанным именем файла. Новая база данных будет содержать то же логическое содержимое, что и исходная база данных, но полностью очищенная.

Именем файла в предложении `INTO` может быть любое SQL-выражение, которое вычисляется как строка. Это должен быть путь к несуществующему файлу или к пустому файлу, иначе команда `VACUUM INTO` приведет к ошибке.

Команда `VACUUM` очень полезна для создания резервных копий действующей базы данных. Это безопасно для транзакций, поскольку сгенерированная база данных является согласованным моментальным снимком исходной базы данных. Однако, если незапланированное завершение работы или отключение питания прервет выполнение команды, сгенерированная база данных может быть повреждена.

Следующий оператор использует команду `VACUUM INTO` для создания новой базы данных с именем файла `chinook_backup.db`, данные которого копируются из основной схемы базы данных `chinook`:

~~~ SQL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
VACUUM main INTO 'c:\sqlite\db\chinook_backup.db';
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

В этом руководстве вы узнали, почему вам нужно использовать команду SQLite `VACUUM` и как ее запустить для оптимизации базы данных.

---------------------------------------

Предидущее руководство < [SQLite GENERATED COLUMNS][prev]  
Следующее руководство > [SQLite SHOW TABLES][next]

[prev]: ../44_GeneratedColumns/translate.md
[next]: ../46_ShowTables/translate.md

[VACUUM]: ./SQLite-VACUUM.jpg